<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词学习平台 - 修复版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }

        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }

        .main-content-area {
            height: 100vh;
        }

        .sidebar-link-active {
            background-color: #ebf8ff;
            color: #2b6cb0;
            font-weight: 600;
        }

        .toggle-checkbox:checked+.toggle-bg {
            background-color: #3B82F6;
            border-color: #3B82F6;
        }

        .toggle-checkbox:checked+.toggle-bg:after {
            transform: translateX(1.5rem);
            background-color: white;
        }

        .toggle-bg:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 1rem;
            height: 1rem;
            background-color: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .subgroup-arrow {
            transition: transform 0.3s ease;
            font-size: 0.75rem;
            transform: rotate(0deg);
        }

        .subgroup-arrow.expanded {
            transform: rotate(90deg);
        }

        .word-card {
            background-color: #f9fafb;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .word-card:hover {
            background-color: #e0f2fe;
            color: #0ea5e9;
            border-color: #baedfd;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .word-card:active {
            transform: translateY(0);
        }

        .word-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px;
        }

        /* Toggle switch styles */
        .toggle {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .switch:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.switch {
            background-color: #3B82F6;
        }

        input:checked+.switch:before {
            transform: translateX(22px);
        }

        /* 搜索状态样式 */
        #search-results-container {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 高亮卡片效果 */
        .word-card-item.highlighted {
            box-shadow: 0 0 0 5px rgba(251, 191, 36, 0.5);
            border: 2px solid #fbbf24 !important;
            animation: pulse-highlight 1.5s ease-in-out;
        }

        @keyframes pulse-highlight {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.5);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, 0);
            }
        }

        /* 待滚动卡片占位符 */
        .scroll-target-indicator {
            position: absolute;
            top: -100px;
            height: 1px;
            width: 100%;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 antialiased">

    <div class="flex h-screen overflow-hidden">
        <button id="sidebar-toggle" aria-label="Toggle sidebar"
            class="lg:hidden fixed top-4 left-4 z-30 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-md shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            <i class="fas fa-bars fa-fw"></i>
        </button>

        <aside id="sidebar"
            class="sidebar-transition bg-white w-64 lg:w-72 fixed lg:static inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 z-20 shadow-xl overflow-y-auto border-r border-gray-200 p-5">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-blue-700 mr-2">单词分组</h1>
                <button id="sidebar-close" aria-label="Close sidebar"
                    class="lg:hidden text-gray-500 hover:text-gray-700 p-2 -mr-2 focus:outline-none focus:ring-2 focus:ring-gray-400 rounded">
                    <i class="fas fa-times fa-fw text-xl"></i>
                </button>
            </div>

            <!-- 搜索框 -->
            <div class="relative mb-4">
                <input type="text" id="sidebar-search" placeholder="搜索分组或单词..."
                    class="w-full px-4 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>

            <!-- 显示单词开关 -->
            <div class="flex items-center mb-4 pb-2 border-b border-dashed border-gray-300">
                <label for="toggle-show-words" class="flex items-center cursor-pointer">
                    <div class="toggle">
                        <input type="checkbox" id="toggle-show-words" class="sr-only" checked>
                        <div class="switch"></div>
                    </div>
                    <span class="ml-3 text-sm font-medium text-gray-700 mr-3">显示单词列表</span>
                    <span id="words-shown-count"
                        class="text-xs bg-blue-500 text-white px-2 py-1 rounded-full">0</span>
                </label>
            </div>

            <!-- 分组列表 -->
            <nav>
                <ul id="group-list" class="space-y-1">
                    <li class="p-3 text-sm text-gray-500">加载中...</li>
                </ul>
            </nav>
        </aside>

        <main class="flex-1 p-6 lg:p-8 overflow-y-auto main-content-area">
            <div class="max-w-5xl mx-auto">
                <header
                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-gray-300">
                    <h2 id="selected-group-title" class="text-3xl font-semibold text-gray-700 mb-3 sm:mb-0">请选择一个单词分组</h2>
                    <div class="flex sm:items-center gap-3">
                        <div class="relative">
                            <input type="text" id="search-input" placeholder="搜索单词..."
                                class="w-full md:w-56 px-4 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <button id="goto-discrimination-btn"
                            class="hidden bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-150 ease-in-out text-sm whitespace-nowrap">
                            <i class="fas fa-microscope mr-2 fa-fw"></i>单词辨析
                        </button>
                    </div>
                </header>

                <div id="word-display-area" class="space-y-6">
                    <div class="text-center py-12 px-6 bg-white rounded-xl shadow-lg">
                        <i class="fas fa-folder-open text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 text-lg">选择一个分组来查看单词内容。</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <input type="hidden" id="initial-topic-id" value="{{ topicId if topicId else '' }}">

    <!-- 模拟数据 -->
    <script>
        const mockVocabularyData = {
            vocabulary_collection: [
                {
                    id: 1,
                    title: "日常用语",
                    description: "日常生活中的常用表达",
                    sub_groups: [
                        {
                            id: 101,
                            title: "问候与介绍",
                            words: [
                                {
                                    word: "hello",
                                    Entry: {
                                        phonetics: "həˈləʊ",
                                        part_of_speech: "int.",
                                        senses: [
                                            {
                                                translation: "你好",
                                                definition: "用于见面时的问候语",
                                                examples: ["Hello there! How are you?", "Hello, my name is John."]
                                            }
                                        ]
                                    },
                                    synonyms: ["hi", "hey"],
                                    antonyms: ["goodbye"]
                                },
                                {
                                    word: "goodbye",
                                    Entry: {
                                        phonetics: "ɡʊdˈbaɪ",
                                        part_of_speech: "int.",
                                        senses: [
                                            {
                                                translation: "再见",
                                                definition: "分别时使用的礼貌用语",
                                                examples: ["Goodbye everyone, see you tomorrow!", "She said goodbye and left."]
                                            }
                                        ]
                                    },
                                    synonyms: ["farewell", "see you later"],
                                    antonyms: ["hello", "hi"]
                                }
                            ]
                        },
                        {
                            id: 102,
                            title: "购物表达",
                            words: [
                                {
                                    word: "price",
                                    Entry: {
                                        phonetics: "praɪs",
                                        part_of_speech: "n.",
                                        senses: [
                                            {
                                                translation: "价格",
                                                definition: "商品或服务的价值",
                                                examples: ["The price of this shirt is too high.", "What's the price for this car?"]
                                            }
                                        ]
                                    }
                                },
                                {
                                    word: "discount",
                                    Entry: {
                                        phonetics: "ˈdɪskaʊnt",
                                        part_of_speech: "n.",
                                        senses: [
                                            {
                                                translation: "折扣",
                                                definition: "从原价中减少的部分",
                                                examples: ["We got a 20% discount on all items.", "Students can get special discounts."]
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                },
                {
                    id: 2,
                    title: "商务英语",
                    sub_groups: [
                        {
                            id: 201,
                            title: "会议英语",
                            words: [
                                {
                                    word: "agenda",
                                    Entry: {
                                        phonetics: "əˈdʒendə",
                                        part_of_speech: "n.",
                                        senses: [
                                            {
                                                translation: "议程",
                                                definition: "会议中要讨论的事项列表",
                                                examples: ["Let's go through the agenda for today's meeting first.", "The next item on the agenda is budget allocation."]
                                            }
                                        ]
                                    }
                                },
                                {
                                    word: "minutes",
                                    Entry: {
                                        phonetics: "ˈmɪnɪts",
                                        part_of_speech: "n.",
                                        senses: [
                                            {
                                                translation: "会议纪要",
                                                definition: "会议上讨论内容和决策的正式记录",
                                                examples: ["Can everyone approve the minutes from the last meeting?", "The secretary took detailed minutes during the conference."]
                                            }
                                        ]
                                    }
                                }
                            ]
                        },
                        {
                            id: 202,
                            title: "商业术语",
                            words: [
                                {
                                    word: "revenue",
                                    Entry: {
                                        phonetics: "ˈrevənjuː",
                                        part_of_speech: "n.",
                                        senses: [
                                            {
                                                translation: "营收",
                                                definition: "公司通过正常业务活动获得的收入总额",
                                                examples: ["Our annual revenue increased by 15% this year.", "The company's main source of revenue is software sales."]
                                            }
                                        ]
                                    }
                                }
                            ]
                        }
                    ]
                }
            ]
        };
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const groupListElement = document.getElementById('group-list');
            const selectedGroupTitleElement = document.getElementById('selected-group-title');
            const wordDisplayAreaElement = document.getElementById('word-display-area');
            const gotoDiscriminationBtn = document.getElementById('goto-discrimination-btn');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarCloseButton = document.getElementById('sidebar-close');
            const sidebar = document.getElementById('sidebar');
            const initialTopicIdElement = document.getElementById('initial-topic-id');
            const searchInput = document.getElementById('search-input');
            const sidebarSearchInput = document.getElementById('sidebar-search');
            const toggleShowWords = document.getElementById('toggle-show-words');
            const wordsShownCount = document.getElementById('words-shown-count');

            let currentSubGroupIdForDiscrimination = null;
            let vocabularyDataGlobal = mockVocabularyData; // 使用模拟数据
            let currentGroupData = null;
            let wordContainers = [];
            let totalWordItems = 0;
            let currentActiveWordCardId = null;

            // Slugify函数创建单词ID的友好版本
            function slugify(str) {
                return str.replace(/[^a-z0-9\u4e00-\u9fa5\u3400-\u4DBF\uF900-\uFAFF-]/gi, '-')
                    .replace(/-+/g, '-') 
                    .replace(/^-|-$/g, '') 
                    .toLowerCase();
            }
            
            // 创建唯一标识符
            function createUniqueWordId(wordObj) {
                // 使用单词内容+索引确保在分组内唯一
                const wordIndex = currentGroupData.words.findIndex(w => w.word === wordObj.word);
                return `word-${wordIndex}-${slugify(wordObj.word)}`;
            }
            
            // 高亮单词卡片方法，带动画效果
            function highlightWordCard(wordId) {
                // 移除之前的高亮状态
                if (currentActiveWordCardId) {
                    const prevCard = document.getElementById(currentActiveWordCardId);
                    if (prevCard) prevCard.classList.remove('highlighted');
                }
                
                // 应用新的高亮状态
                const card = document.getElementById(wordId);
                if (card) {
                    card.classList.add('highlighted');
                    currentActiveWordCardId = wordId;
                    
                    // 滚动到卡片位置（加一点偏移量）
                    setTimeout(() => {
                        const topPosition = card.getBoundingClientRect().top - 150;
                        window.scrollTo({
                            top: topPosition,
                            behavior: 'smooth'
                        });
                    }, 300);
                }
            }
            
            // 滚动到指定单词位置
            function scrollToWord(wordId) {
                if (currentGroupData && document.getElementById(wordId)) {
                    // 如果当前已经显示该分组，直接滚动到目标单词
                    highlightWordCard(wordId);
                } else {
                    // 如果单词在另一个分组，需要先展示该分组
                    console.warn("单词不在当前分组中，需要切换到目标分组:", wordId);
                }
            }

            // --- Sidebar Toggle Functionality ---
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('translate-x-0');
                    if (window.innerWidth < 1024) {
                        sidebarToggle.classList.add('hidden');
                    }
                });
            }
            if (sidebarCloseButton && sidebar) {
                sidebarCloseButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    if (window.innerWidth < 1024) {
                        sidebarToggle.classList.remove('hidden');
                    }
                });
            }
            document.addEventListener('click', (event) => {
                if (sidebar && sidebarToggle && !sidebar.contains(event.target) &&
                    !sidebarToggle.contains(event.target) && window.innerWidth < 1024) {
                    if (!sidebar.classList.contains('-translate-x-full')) {
                        sidebar.classList.remove('translate-x-0');
                        sidebar.classList.add('-translate-x-full');
                        sidebarToggle.classList.remove('hidden');
                    }
                }
            });

            // Sidebar search functionality
            if (sidebarSearchInput) {
                sidebarSearchInput.addEventListener('input', function () {
                    const searchTerm = this.value.trim().toLowerCase();

                    if (!searchTerm) {
                        initializePage(); // 重置时重新初始化页面
                        return;
                    }

                    const searchResultsContainer = document.createElement('div');
                    searchResultsContainer.id = 'search-results-container';
                    searchResultsContainer.className = 'space-y-2';
                    groupListElement.innerHTML = '';
                    groupListElement.appendChild(searchResultsContainer);

                    let anyMatchFound = false;
                    let resultCount = 0;

                    vocabularyDataGlobal.vocabulary_collection.forEach(collection => {
                        if (!collection.sub_groups) return;

                        collection.sub_groups.forEach(subGroup => {
                            const matches = [];

                            // 检查分组标题匹配
                            const collectionTitle = collection.title.toLowerCase();
                            const subGroupTitle = subGroup.title.toLowerCase();
                            let groupMatched = false;

                            if (collectionTitle.includes(searchTerm) || subGroupTitle.includes(searchTerm)) {
                                groupMatched = true;
                            }

                            // 检查单词匹配
                            if (subGroup.words && subGroup.words.length > 0) {
                                subGroup.words.forEach(wordObj => {
                                    const word = wordObj.word.toLowerCase();
                                    if (word.includes(searchTerm)) {
                                        matches.push({
                                            wordObj,
                                            subgroupId: subGroup.id,
                                            groupTitle: `${collection.title} > ${subGroup.title}`
                                        });
                                        groupMatched = true;
                                        resultCount++;
                                    }
                                });
                            }

                            // 如果有匹配
                            if (groupMatched) {
                                anyMatchFound = true;

                                // 添加分组标题到搜索结果
                                const groupLink = document.createElement('a');
                                groupLink.className = 'block px-3 py-2 text-sm rounded-md bg-blue-50 text-blue-700 font-medium cursor-pointer hover:bg-blue-100';
                                groupLink.innerHTML = `<i class="fas fa-folder mr-2 w-4 text-center"></i> ${collection.title} / ${subGroup.title}`;
                                groupLink.addEventListener('click', () => {
                                    window.location.href = `/?topicId=${subGroup.id}`;
                                });
                                searchResultsContainer.appendChild(groupLink);

                                // 添加单词匹配项
                                matches.forEach(match => {
                                    const wordLink = document.createElement('a');
                                    wordLink.className = 'block px-3 py-2 text-sm rounded-md ml-4 bg-green-50 text-green-700 hover:bg-green-100 flex items-center';
                                    wordLink.innerHTML = `<i class="fas fa-search mr-3 text-xs w-4 text-center"></i> <span class="font-medium mr-2">${match.wordObj.word}</span> <i class="fas fa-chevron-right text-xs ml-auto"></i>`;
                                    wordLink.addEventListener('click', (e) => {
                                        e.stopPropagation();
                                        const wordId = createUniqueWordId(match.wordObj);
                                        
                                        // 先切换到该子分组
                                        const targetSubGroup = findSubGroupById(match.subgroupId);
                                        if (targetSubGroup) {
                                            // 加载分组内容
                                            displayWords(targetSubGroup);
                                            
                                            // 等待DOM更新后滚动到该单词
                                            setTimeout(() => {
                                                scrollToWord(wordId);
                                            }, 100);
                                        }
                                    });
                                    searchResultsContainer.appendChild(wordLink);
                                });
                            }
                        });
                    });

                    if (!anyMatchFound) {
                        const noResultsDiv = document.createElement('div');
                        noResultsDiv.className = 'p-3 text-center text-gray-500 text-sm';
                        noResultsDiv.innerHTML = `<i class="fas fa-search mr-2"></i>没有找到匹配的单词或分组`;
                        searchResultsContainer.appendChild(noResultsDiv);
                    } else {
                        // 添加搜索结果统计
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'text-xs text-gray-500 px-3 pt-2 pb-1 bg-gray-50 rounded-b';
                        infoDiv.innerHTML = `找到 ${resultCount} 个匹配的单词`;
                        searchResultsContainer.appendChild(infoDiv);
                    }
                });
            }

            // 监听显示单词开关变化
            if (toggleShowWords) {
                toggleShowWords.addEventListener('change', function () {
                    const isChecked = this.checked;
                    localStorage.setItem('showWordsInSidebar', isChecked ? 'true' : 'false');

                    // 显示/隐藏所有单词列表容器
                    wordContainers.forEach(container => {
                        if (!isChecked) {
                            container.classList.add('hidden');
                        } else {
                            container.classList.remove('hidden');
                        }
                    });

                    // 更新开关右侧计数显示
                    wordsShownCount.textContent = isChecked ? totalWordItems : "0";

                    // 如果启用，将展开箭头设为展开状态
                    document.querySelectorAll('.subgroup-arrow').forEach(arrow => {
                        arrow.classList.toggle('expanded', isChecked);
                    });
                });
            }

            // Word search functionality in main content
            if (searchInput) {
                searchInput.addEventListener('input', function () {
                    const searchTerm = this.value.trim().toLowerCase();
                    filterWords(searchTerm);
                });
            }

            function filterWords(searchTerm) {
                if (!currentGroupData) {
                    console.warn("No group selected, cannot filter words.");
                    return;
                }

                const filteredWords = [];
                if (currentGroupData.words) {
                    currentGroupData.words.forEach(wordObj => {
                        const word = wordObj.word.toLowerCase();
                        const translation = (wordObj.Entry?.senses?.[0]?.translation || '').toLowerCase();
                        const definition = (wordObj.Entry?.senses?.[0]?.definition || '').toLowerCase();

                        if (word.includes(searchTerm) || translation.includes(searchTerm) || definition.includes(searchTerm)) {
                            filteredWords.push(wordObj);
                        }
                    });
                }

                const filteredGroup = Object.assign({}, currentGroupData, { words: filteredWords });
                displayWords(filteredGroup, true);
            }

            // 根据ID查找子分组
            function findSubGroupById(id) {
                for (const collection of vocabularyDataGlobal.vocabulary_collection) {
                    if (collection.sub_groups) {
                        const foundSubGroup = collection.sub_groups.find(
                            sg => String(sg.id) === String(id)
                        );
                        if (foundSubGroup) return foundSubGroup;
                    }
                }
                return null;
            }

            // --- Button Click Handler ---
            function handleGoToDiscrimination() {
                if (currentSubGroupIdForDiscrimination) {
                    window.location.href = `/discrimination?topicId=${encodeURIComponent(currentSubGroupIdForDiscrimination)}`;
                } else if (currentGroupData && currentGroupData.id) {
                    window.location.href = `/discrimination?topicId=${encodeURIComponent(currentGroupData.id)}`;
                } else {
                    alert('当前没有可用的单词分组');
                }
            }

            // --- Display Words in Main Content (for index.html) ---
            function displayWords(subGroup, isFiltered = false) {
                if (!selectedGroupTitleElement || !wordDisplayAreaElement || !gotoDiscriminationBtn) return;

                if (!isFiltered) {
                    if (subGroup && subGroup.title) {
                        selectedGroupTitleElement.textContent = subGroup.title;
                        currentGroupData = subGroup;
                    } else {
                        wordDisplayAreaElement.innerHTML = `
                            <div class="text-center py-12 px-6 bg-white rounded-xl shadow-lg">
                                <i class="fas fa-exclamation-triangle text-5xl text-yellow-500 mb-4"></i>
                                <p class="text-gray-500 text-lg">该分组不存在或无数据。</p>
                            </div>`;
                        gotoDiscriminationBtn.classList.add('hidden');
                        return;
                    }
                }

                wordDisplayAreaElement.innerHTML = '';
                currentSubGroupIdForDiscrimination = null;

                // 添加滚动目标占位符（用于平滑滚动）
                const scrollTarget = document.createElement('div');
                scrollTarget.className = 'scroll-target-indicator';
                scrollTarget.id = 'scroll-target';
                wordDisplayAreaElement.appendChild(scrollTarget);

                if (!subGroup.words || subGroup.words.length === 0) {
                    const emptyMessage = document.createElement('div');
                    emptyMessage.className = 'text-center py-12 px-6 bg-white rounded-xl shadow-lg';
                    emptyMessage.innerHTML = `
                        <i class="fas fa-box-open text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 text-lg">${isFiltered ? '未找到匹配的单词' : '此分组没有单词'}</p>
                    `;
                    wordDisplayAreaElement.appendChild(emptyMessage);
                    gotoDiscriminationBtn.classList.add('hidden');
                    gotoDiscriminationBtn.removeEventListener('click', handleGoToDiscrimination);
                    return;
                }

                currentSubGroupIdForDiscrimination = String(subGroup.id);
                gotoDiscriminationBtn.classList.remove('hidden');
                gotoDiscriminationBtn.classList.add('inline-flex');
                gotoDiscriminationBtn.removeEventListener('click', handleGoToDiscrimination);
                gotoDiscriminationBtn.addEventListener('click', handleGoToDiscrimination);

                const ul = document.createElement('ul');
                ul.className = 'space-y-6';

                subGroup.words.forEach((wordObj, index) => {
                    const li = document.createElement('li');
                    li.className = 'word-card-item bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 ease-in-out';
                    
                    // 为单词卡片创建唯一ID
                    const wordId = createUniqueWordId(wordObj);
                    li.setAttribute('id', wordId);

                    let sensesHTML = '';
                    if (wordObj.Entry && wordObj.Entry.senses && wordObj.Entry.senses.length > 0) {
                        sensesHTML = '<ul class="mt-4 space-y-3 text-gray-700">';
                        wordObj.Entry.senses.forEach((sense, index) => {
                            sensesHTML += `<li class="border-l-4 border-blue-200 pl-4 py-1">
                                             <strong class="block text-blue-700 text-base">${index + 1}. ${sense.translation}</strong>
                                             <span class="text-gray-600 text-sm">${sense.definition}</span>
                                          </li>`;
                        });
                        sensesHTML += '</ul>';
                    } else {
                        sensesHTML = '<p class="mt-3 text-sm text-gray-500 italic">暂无详细释义。</p>';
                    }

                    li.innerHTML = `
                        <div class="word-header-container flex justify-between items-center cursor-pointer mb-3 pb-3 border-b border-gray-200">
                            <div>
                                <span class="english-word text-2xl font-semibold text-gray-800">${wordObj.word}</span>
                                <span class="reveal-word-prompt text-sm text-blue-600 hover:text-blue-800 font-medium py-1 px-3 border border-blue-500 hover:bg-blue-100 rounded-full transition-colors duration-150 hidden">(显示单词)</span>
                            </div>
                            <p class="part-of-speech text-xs text-indigo-700 bg-indigo-100 px-2.5 py-1 rounded-full font-medium"><em>${wordObj.Entry ? wordObj.Entry.part_of_speech : '词性未知'}</em></p>
                        </div>
                        ${sensesHTML}
                    `;

                    ul.appendChild(li);
                });

                wordDisplayAreaElement.appendChild(ul);

                // 滚动到顶部目标位置
                setTimeout(() => {
                    const targetPosition = scrollTarget.getBoundingClientRect().top - 100;
                    window.scrollTo({
                        top: targetPosition,
                        behavior: 'smooth'
                    });
                }, 50);
            }

            // 处理子分组点击
            function handleSubgroupClick(event, subGroup) {
                console.log("Handling subgroup click:", subGroup.title);
                if (wordDisplayAreaElement && selectedGroupTitleElement) {
                    displayWords(subGroup);
                    window.history.pushState({ topicId: subGroup.id }, subGroup.title, `/?topicId=${subGroup.id}`);
                    document.querySelectorAll('#group-list a.subgroup-title').forEach(item => {
                        item.classList.remove('sidebar-link-active');
                        if (!item.classList.contains('sidebar-link-active')) {
                            item.classList.add('text-gray-600', 'hover:text-gray-800');
                        }
                    });
                    event.currentTarget.classList.add('sidebar-link-active');
                    event.currentTarget.classList.remove('hover:bg-gray-100', 'hover:text-gray-800');
                }

                if (window.innerWidth < 1024 && sidebar && !sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('translate-x-0');
                    sidebar.classList.add('-translate-x-full');
                    sidebarToggle.classList.remove('hidden');
                }
            }

            // 处理单词点击：跳转到单词位置
            function handleWordClick(wordObj, subGroupId, event) {
                event.preventDefault();
                event.stopPropagation();
                console.log("Word clicked:", wordObj.word, "in group", subGroupId);

                // 获取当前分组ID
                const urlParams = new URLSearchParams(window.location.search);
                const currentTopicId = urlParams.get('topicId') || "";

                // 如果单词在当前分组中
                if (String(currentTopicId) === String(subGroupId)) {
                    // 切换到当前分组（如果已在该分组，可以跳过这步）
                    const subGroup = findSubGroupById(subGroupId);
                    if (subGroup) {
                        const wordId = createUniqueWordId(wordObj);
                        highlightWordCard(wordId);
                    }
                } else {
                    // 目标单词属于另一个分组 - 显示该分组并滚动到单词位置
                    const targetSubGroup = findSubGroupById(subGroupId);
                    if (targetSubGroup) {
                        displayWords(targetSubGroup);
                        
                        // 更新URL，反映新的子分组
                        window.history.pushState({ topicId: subGroupId }, targetSubGroup.title, `/?topicId=${subGroupId}`);
                        
                        // 添加延迟以确保DOM更新完成
                        setTimeout(() => {
                            const wordId = createUniqueWordId(wordObj);
                            highlightWordCard(wordId);
                        }, 500);
                        
                        // 高亮侧边栏中的目标分组
                        const allSubGroupLinks = document.querySelectorAll('#group-list a.subgroup-title');
                        allSubGroupLinks.forEach(link => {
                            link.classList.remove('sidebar-link-active');
                        });
                        const targetLink = Array.from(allSubGroupLinks).find(
                            link => link.dataset.subGroupId === String(subGroupId)
                        );
                        if (targetLink) {
                            targetLink.classList.add('sidebar-link-active');
                        }
                    }
                }
            }

            // --- Populate Sidebar ---
            function populateSidebar(loadedVocabularyData, activeTopicId = null) {
                if (!groupListElement) {
                    console.error("Error: Sidebar group list element (ul#group-list) is not found!");
                    return;
                }
                groupListElement.innerHTML = '';
                wordContainers = []; // 重置单词容器数组
                totalWordItems = 0; // 重置单词计数

                if (!loadedVocabularyData || !loadedVocabularyData.vocabulary_collection) {
                    console.error("Error: vocabulary_collection is missing in loaded data for sidebar.");
                    groupListElement.innerHTML = '<li class="p-3 text-sm text-red-500">词汇数据格式不正确或加载失败。</li>';
                    return;
                }

                if (gotoDiscriminationBtn) {
                    gotoDiscriminationBtn.classList.add('hidden');
                    gotoDiscriminationBtn.removeEventListener('click', handleGoToDiscrimination);
                }

                loadedVocabularyData.vocabulary_collection.forEach(collection => {
                    const collectionLi = document.createElement('li');
                    collectionLi.className = 'mb-2';

                    const collectionTitleButton = document.createElement('button');
                    collectionTitleButton.className = 'collapsible-title w-full text-left px-3 py-2.5 font-semibold text-gray-700 hover:bg-gray-100 rounded-md focus:outline-none transition-colors duration-150 flex justify-between items-center text-sm';
                    collectionTitleButton.innerHTML = `
                        <span>${collection.title}</span>
                        <i class="fas fa-chevron-right transform transition-transform duration-200 text-gray-500 text-xs arrow-icon"></i>
                    `;
                    collectionLi.appendChild(collectionTitleButton);

                    if (collection.sub_groups && collection.sub_groups.length > 0) {
                        const subGroupUl = document.createElement('ul');
                        subGroupUl.className = 'subgroup-list mt-1 ml-3 pl-3 border-l-2 border-gray-200 space-y-2 hidden';
                        let isParentExpanded = false;

                        collection.sub_groups.forEach(subGroup => {
                            const subGroupLi = document.createElement('li');
                            subGroupLi.className = 'subgroup-item mb-2';

                            // 子分组标题
                            const subGroupLink = document.createElement('a');
                            subGroupLink.className = `subgroup-title block px-3 py-2 text-sm rounded-md transition-colors duration-150 items-center justify-between cursor-pointer flex`;

                            // 添加分组ID到dataset
                            subGroupLink.dataset.subGroupId = subGroup.id;
                            subGroupLink.dataset.groupTitle = subGroup.title;

                            const isSubGroupActive = String(subGroup.id) === activeTopicId;

                            if (isSubGroupActive) {
                                subGroupLink.classList.add('sidebar-link-active');
                                isParentExpanded = true;
                            } else {
                                subGroupLink.classList.add('text-gray-600', 'hover:text-gray-800', 'hover:bg-gray-100');
                            }

                            const contentSpan = document.createElement('span');
                            contentSpan.className = 'flex-1 truncate flex items-center';

                            const titleSpan = document.createElement('span');
                            titleSpan.textContent = subGroup.title;

                            const wordCount = subGroup.words ? subGroup.words.length : 0;
                            const wordCountSpan = document.createElement('span');
                            wordCountSpan.className = 'ml-2 bg-gray-200 rounded-full px-2 py-0.5 text-xs text-gray-600';
                            wordCountSpan.textContent = wordCount > 0 ? `${wordCount}` : '0';

                            contentSpan.appendChild(titleSpan);
                            contentSpan.appendChild(wordCountSpan);

                            const expandBtn = document.createElement('i');
                            expandBtn.className = 'subgroup-arrow fas fa-chevron-right ml-2 text-gray-400 text-xs cursor-pointer';

                            if (subGroup.words && subGroup.words.length > 0) {
                                expandBtn.classList.add('flex-shrink-0');
                            }

                            subGroupLink.appendChild(contentSpan);
                            subGroupLink.appendChild(expandBtn);

                            // 添加标题点击事件
                            subGroupLink.addEventListener('click', (event) => {
                                if (expandBtn.contains(event.target)) {
                                    // 点击了箭头图标，展开/折叠单词列表
                                    const wordListContainer = event.currentTarget.nextElementSibling;
                                    if (wordListContainer && wordListContainer.classList.contains('word-list-container')) {
                                        wordListContainer.classList.toggle('hidden');
                                        expandBtn.classList.toggle('expanded');
                                        event.stopPropagation();
                                    }
                                } else {
                                    // 点击了子分组标题，加载该分组内容
                                    handleSubgroupClick(event, subGroup);
                                }
                            });

                            subGroupLi.appendChild(subGroupLink);

                            // 单词列表容器
                            if (subGroup.words && subGroup.words.length > 0) {
                                totalWordItems += subGroup.words.length;
                                const wordListContainer = document.createElement('div');
                                wordListContainer.className = 'word-list-container ml-5 mt-2 space-y-1';
                                wordContainers.push(wordListContainer); // 添加到全局数组

                                // 创建单词列表网格
                                const wordList = document.createElement('div');
                                wordList.className = 'word-grid p-1';

                                subGroup.words.forEach(wordObj => {
                                    const wordItem = document.createElement('div');
                                    wordItem.className = 'word-card flex items-center justify-center cursor-pointer';
                                    
                                    // 添加到单词元素的额外信息
                                    wordItem.dataset.word = wordObj.word;
                                    wordItem.dataset.groupId = subGroup.id;
                                    
                                    // 添加点击事件
                                    wordItem.addEventListener('click', (e) => handleWordClick(wordObj, subGroup.id, e));
                                    
                                    // 添加单词卡片视觉元素
                                    const wordText = document.createElement('span');
                                    wordText.textContent = wordObj.word;
                                    wordText.className = 'mr-1';
                                    
                                    const icon = document.createElement('i');
                                    icon.className = 'fas fa-mouse-pointer text-xs text-gray-500 opacity-70';
                                    
                                    wordItem.appendChild(wordText);
                                    wordItem.appendChild(icon);
                                    wordList.appendChild(wordItem);
                                });

                                wordListContainer.appendChild(wordList);
                                subGroupLi.appendChild(wordListContainer);
                            }

                            subGroupUl.appendChild(subGroupLi);
                        });
                        collectionLi.appendChild(subGroupUl);

                        if (isParentExpanded) {
                            subGroupUl.classList.remove('hidden');
                            collectionTitleButton.querySelector('.arrow-icon').classList.replace('fa-chevron-right', 'fa-chevron-down');
                        }

                        collectionTitleButton.addEventListener('click', () => {
                            subGroupUl.classList.toggle('hidden');
                            const icon = collectionTitleButton.querySelector('.arrow-icon');
                            if (subGroupUl.classList.contains('hidden')) {
                                icon.classList.replace('fa-chevron-down', 'fa-chevron-right');
                            } else {
                                icon.classList.replace('fa-chevron-right', 'fa-chevron-down');
                            }
                        });
                    } else {
                        collectionTitleButton.querySelector('.arrow-icon').classList.add('hidden');
                    }
                    groupListElement.appendChild(collectionLi);
                });

                // 更新单词计数显示
                wordsShownCount.textContent = totalWordItems;

                // 应用之前保存的设置
                const showWords = localStorage.getItem('showWordsInSidebar');

                if (toggleShowWords) {
                    toggleShowWords.checked = showWords !== 'false';

                    // 根据设置显示/隐藏单词列表
                    wordContainers.forEach(container => {
                        if (!toggleShowWords.checked) {
                            container.classList.add('hidden');
                        }
                    });

                    // 更新单词计数显示
                    wordsShownCount.textContent = toggleShowWords.checked ? totalWordItems : '0';
                }
            }

            window.addEventListener('popstate', (event) => {
                if (wordDisplayAreaElement && selectedGroupTitleElement) {
                    const newTopicId = event.state?.topicId || new URLSearchParams(window.location.search).get('topicId');
                    if (newTopicId && vocabularyDataGlobal) {
                        let foundSubGroup = null;
                        for (const collection of vocabularyDataGlobal.vocabulary_collection) {
                            if (collection.sub_groups) {
                                foundSubGroup = collection.sub_groups.find(sg => String(sg.id) === newTopicId);
                                if (foundSubGroup) break;
                            }
                        }
                        if (foundSubGroup) {
                            displayWords(foundSubGroup);
                            document.querySelectorAll('#group-list a.subgroup-title').forEach(item => {
                                item.classList.remove('sidebar-link-active');
                                item.classList.add('text-gray-600', 'hover:text-gray-800');
                                if (item.dataset.subGroupId === newTopicId) {
                                    item.classList.add('sidebar-link-active');
                                    item.classList.remove('hover:bg-gray-100', 'hover:text-gray-800');
                                }
                            });
                        }
                    } else if (!newTopicId) {
                        selectedGroupTitleElement.textContent = '请选择一个单词分组';
                        wordDisplayAreaElement.innerHTML = `
                            <div class="text-center py-12 px-6 bg-white rounded-xl shadow-lg">
                                <i class="fas fa-folder-open text-5xl text-gray-400 mb-4"></i>
                                <p class="text-gray-500 text-lg">选择一个分组来查看单词内容。</p>
                            </div>`;
                        if (gotoDiscriminationBtn) gotoDiscriminationBtn.classList.add('hidden');
                        document.querySelectorAll('#group-list a').forEach(item => item.classList.remove('sidebar-link-active'));
                        currentGroupData = null;
                    }
                }
            });

            // 监听URL变化函数（用于处理锚点滚动）
            function handleUrlChanges() {
                const urlParams = new URLSearchParams(window.location.search);
                const fragmentString = location.hash.slice(1); // 移除#字符
                
                if (fragmentString.startsWith("word=")) {
                    const wordSlug = fragmentString.split("=")[1];
                    const wordId = `word-${wordSlug}`;
                    
                    // 延迟执行以确保DOM已经更新
                    setTimeout(() => {
                        scrollToWord(wordId);
                    }, 300);
                }
            }
            
            // 首次加载时及URL变化时处理可能存在的锚点
            window.addEventListener('load', handleUrlChanges);
            window.addEventListener('hashchange', handleUrlChanges);
            
            async function initializePage() {
                // 如果以后需要切换真实API，去掉下面注释
                // const data = await loadJsonData();
                // if (data) {
                //    vocabularyDataGlobal = data;
                // }
                
                if (vocabularyDataGlobal) {
                    let activeTopicId = null;
                    const urlParams = new URLSearchParams(window.location.search);

                    if (initialTopicIdElement && initialTopicIdElement.value) {
                        activeTopicId = initialTopicIdElement.value;
                    } else {
                        activeTopicId = urlParams.get('topicId');
                    }

                    populateSidebar(vocabularyDataGlobal, activeTopicId);

                    if (activeTopicId && wordDisplayAreaElement && selectedGroupTitleElement) {
                        let foundSubGroup = null;
                        for (const collection of vocabularyDataGlobal.vocabulary_collection) {
                            if (collection.sub_groups) {
                                foundSubGroup = collection.sub_groups.find(sg => String(sg.id) === String(activeTopicId));
                                if (foundSubGroup) break;
                            }
                        }
                        if (foundSubGroup) {
                            displayWords(foundSubGroup);
                            if (!urlParams.has('topicId') || urlParams.get('topicId') !== String(activeTopicId)) {
                                window.history.replaceState({ topicId: activeTopicId }, foundSubGroup.title, `/?topicId=${activeTopicId}`);
                            }
                        } else {
                            selectedGroupTitleElement.textContent = "未找到分组";
                            wordDisplayAreaElement.innerHTML = `<div class="p-4 text-sm text-yellow-700 bg-yellow-100 rounded-lg shadow-md" role="alert">
                                                                <span class="font-medium">提示:</span> 未找到 ID 为 "${activeTopicId}" 的单词分组。
                                                              </div>`;
                        }
                    } else if (!activeTopicId && wordDisplayAreaElement && selectedGroupTitleElement) {
                        selectedGroupTitleElement.textContent = '请选择一个单词分组';
                        wordDisplayAreaElement.innerHTML = `
                            <div class="text-center py-12 px-6 bg-white rounded-xl shadow-lg">
                                <i class="fas fa-folder-open text-5xl text-gray-400 mb-4"></i>
                                <p class="text-gray-500 text-lg">选择一个分组来查看单词内容。</p>
                            </div>`;
                    }
                }
            }
            initializePage();
        });
    </script>
</body>
</html>
